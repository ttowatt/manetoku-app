<%= render "public/header2" %>
<div class="container py-5">
  <div class="card card-header-color mx-auto" style="max-width: 800px; border-radius: 1rem;">
    <div class="card-body text-center">

      <!-- プロフィール画像 -->
      <div class="mb-3">
        <%= image_tag @user.get_profile_image, size: '200x200', class: "rounded-circle border", alt: "プロフィール画像" %>
      </div>

      <!-- ユーザー名 -->
      <h3 class="font-weight-bold mb-3"><%= @user.username %></h3>

      <!-- フォローボタン or 編集ボタン -->
      <div class="d-flex justify-content-center align-items-center mb-4">
        <% if current_user == @user %>
          <%= link_to "プロフィールを編集(退会)", edit_public_user_path(current_user), class: "btn btn-outline-primary mx-2" %>
          <%= link_to "投稿する", new_public_post_path, class: "btn btn-primary mx-2" %>
        <% else %>
          <div id="follow_button">
            <% if current_user.following.include?(@user) %>
              <%= button_to "フォロー解除", public_user_follow_path(@user),
                    method: :delete, remote: true, class: "btn btn-outline-danger mx-2" %>
            <% else %>
              <%= button_to "フォロー", public_user_follow_path(@user),
                    method: :post, remote: true, class: "btn btn-primary mx-2" %>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- 投稿・フォロー・フォロワー数 -->
      <div class="row text-center mb-4">
        <div class="col">
          <p class="mb-1 text-muted">投稿</p>
          <h5><%= @user.posts.count %></h5>
        </div>
        <div class="col">
          <p class="mb-1 text-muted">フォロー</p>
          <h5><%= @user.following.count %></h5>
        </div>
        <div class="col">
          <p class="mb-1 text-muted">フォロワー</p>
          <h5><%= @user.followers.count %></h5>
        </div>
      </div>

      <!-- タブ切り替えボタン -->
      <ul class="nav nav-tabs justify-content-center border-bottom pb-2 mb-4" role="tablist">
        <li class="nav-item">
          <a class="nav-link active font-weight-bold text-dark" data-toggle="tab" href="#posts" role="tab">投稿</a>
        </li>
        <li class="nav-item">
          <a class="nav-link font-weight-bold text-dark" data-toggle="tab" href="#likes" role="tab">いいね</a>
        </li>
        <li class="nav-item">
          <a class="nav-link font-weight-bold text-dark" data-toggle="tab" href="#reviews" role="tab">評価</a>
        </li>
      </ul>

      <!-- タブの中身 -->
      <div class="tab-content mt-3">

        <!-- 投稿一覧 -->
        <div class="tab-pane fade show active" id="posts" role="tabpanel">
          <div class="row">
            <% @posts.each do |post| %>
              <%= render "public/users/profile_posts", post: post %>
            <% end %>
          </div>
        </div>

        <!-- いいねタブ -->
        <div class="tab-pane fade" id="likes" role="tabpanel">
          <div class="row">
            <% @user.liked_posts.each do |post| %>
             <%= render "public/users/profile_posts", post: post %>
            <% end %>
          </div>
        </div>

        <!-- 評価タブ -->
        <div class="tab-pane fade" id="reviews" role="tabpanel">
          <div class="list-group mb-5">
            <% if @user.reviews.any? %>
              <% @user.reviews.each do |review| %>
                <div class="list-group-item mb-3 border rounded shadow-sm p-3">
                  <div class="align-items-center mb-2">
                    <% if review.post.present? %>
                      <h5 class="mb-0 mr-2">
                        <%= link_to review.post.title, public_post_path(review.post), class: "font-weight-bold" %>
                      </h5>
                    <% else %>
                      <span class="text-muted mr-2">削除された投稿</span>
                    <% end %>

                    <small class="text-muted">
                      投稿者：
                      <% if review.post&.user.present? %>
                        <%= link_to review.post.user.username, public_user_path(review.post.user) %>
                      <% else %>
                        <span class="text-muted">退会済みユーザー</span>
                      <% end %>
                    </small>

                    <!-- 星評価表示 -->
                    <div class="review-stars ml-2">
                      <% 1.upto(5) do |i| %>
                        <% if i <= review.star.to_i %>
                          <i class="fa-solid fa-star" style="color: gold;"></i>
                        <% else %>
                          <i class="fa-regular fa-star" style="color: #ccc;"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </div>

                  <!-- レビュー本文 -->
                  <p class="mb-1"><%= review.body %></p>

                  <!-- 投稿者情報 -->
                  

                  <!-- 削除ボタン（自分のレビューのみ） -->
                  <% if review.user == current_user %>
                    <div class="text-right mt-2">
                      <%= link_to "削除",
                                  public_post_review_path(review.post, review),
                                  method: :delete,
                                  data: { confirm: "このレビューを削除しますか？" },
                                  class: "btn btn-sm btn-outline-danger" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p class="text-muted">まだレビューはありません。</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
